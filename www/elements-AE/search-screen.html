<link rel="import" href="../dependencies/core-scroll-header-panel/core-scroll-header-panel.html">
<link rel="import" href="../dependencies/core-toolbar/core-toolbar.html">
<link rel="import" href="../dependencies/core-icon-button/core-icon-button.html">
<link rel="import" href="../dependencies/core-list/core-list.html">
<polymer-element name="search-screen" extends="force-route" attributes="sobject searchfields fieldstofetch resultHeight">
    <template>

        <style>
            force-ui-search /deep/ paper-input::shadow #floatedLabel {
                display: none;
            }
            force-ui-search /deep/ paper-input::shadow #errorContainer {
                display: none;
            }
            force-ui-search /deep/ #underline>div {
                background-color: white
            }
            force-ui-search /deep/ .cursor {
                background-color: white
            }
            force-ui-search /deep/ input {
                color: white;
            }

            core-scroll-header-panel {
                position: absolute;
                top: 0; bottom: 0;
                left: 0; right: 0;
            }

            :host /deep/ core-icon {
                fill: #fff;
            }

            /* background for toolbar when it is at its full size */
            core-scroll-header-panel::shadow #headerBg {
                background-image: url(banner.jpg);
            }

            /* background for toolbar when it is condensed */
            core-scroll-header-panel::shadow #condensedHeaderBg {
                background-color: #00adef;
            }

            core-toolbar {
                color: #f1f1f1;
                fill: #f1f1f1;
                background-color: transparent;
            }

            .title {
                font-size: 40px;
            }

            #scrollHeader::shadow #headerContainer {
                transition: transform 200ms ease-out;
                -webkit-transition: -webkit-transform 200ms ease-out;
            }

            #scrollHeader::shadow #mainContainer {
                /*overflow: hidden;*/
                margin-top: 64px;
            }

        </style>

        <core-scroll-header-panel id="scrollHeader" style="-webkit-overflow-scrolling: touch;" touch-action="pan-y">
        	
            <core-toolbar id="header" style="background-color: #f40009;">

                <core-icon id="menu-icon" icon="menu"></core-icon>
                <div id="title" flex>{{$.list.collection.models.length || ""}} Contacts</div>
                <core-icon id="apps-icon" icon="apps"></core-icon>
                
            </core-toolbar>
            <core-toolbar id="toolbar" style="background-color: #bdc3c7;">
        
                <core-icon id="search-icon" icon="search"></core-icon>
                <div flex>
                    <force-ui-search id="search" sobject="{{sobject}}" searchfields="{{searchfields}}" fieldstofetch="{{fieldstofetch}}" cachemode="{{cachemode}}"></force-ui-search>
                </div>
                <core-icon id="create-icon" icon="add" on-tap="{{navigateToCreate}}"></core-icon>
              
            </core-toolbar>

            <div class="content" style="height: 100%">
                <img id="loading" src="loading-gray.gif" style="position: absolute; top: 50%; left: 45%; width: 32px;"/>
                <force-sobject-sync sobject="{{sobject}}" fieldstoindex="{{searchfields}}" query="{{syncQuery}}" on-synccomplete="{{fetchData}}"></force-sobject-sync>
                <force-sobject-collection id="list" sobject="{{sobject}}" querytype="{{$.search.querytype}}" query="{{$.search.query}}" style="display:none" autosync="false"></force-sobject-collection>
                <core-list id="uilist" height="{{resultHeight}}" style="height:100%" data="{{$.list.collection.models}}" on-touchend="{{stopClick}}">
                    <content select="*"></content>
                </core-list>

            </div>

        </core-scroll-header-panel>

    </template>
    <script>
    	(function() {

	        Polymer('search-screen', {
	          cachemode: Force.CACHE_MODE.CACHE_ONLY,
	          ready: function() {
	            this.super();
	            this.fetchData();
	            this.setupSyncQuery();
	          },

	          fetchData: function() {
	            var onFetch = function() {
	              if (this.$.list.collection.size() > 0) {
                    this.$.loading.style.display = "none";
                    this.$.list.autosync = true;
	              }
	              this.$.list.removeEventListener('sync', onFetch);
	            }.bind(this);
	            if (!this.$.list.autosync) {
	              this.$.list.addEventListener('sync', onFetch);
	              this.async(function() { this.$.list.fetch(); });
	            }
	          },

	          setupSyncQuery: function() {
	            var searchFields = this.searchfields.trim().split(/\s+/);
	            var fieldsToFetch = this.fieldstofetch ? this.fieldstofetch.trim().split(/\s+/) : [];
	            fieldsToFetch = _.union(searchFields, fieldsToFetch);

	            this.syncQuery = "SELECT Id, " + fieldsToFetch.join(',') + " FROM " + this.sobject + " LIMIT 200";
	          },

	          stopClick: function(e) {
	            e.preventDefault();
	          },

	          attached: function() {
	            this.$.uilist.appendChild(this.querySelector('template'));
	          },              

	          updateConnection: function() {
	            this.$.search.computeQuery();
	          },

	          refresh: function() {
	            this.$.list.fetch();
	          },

	          navigateToCreate: function() {
	            window.location.hash = "#edit";
	          }
	        });
		})();
    </script>
</polymer-element>

