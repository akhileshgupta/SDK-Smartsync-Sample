<link rel="import" href="../dependencies/core-scroll-header-panel/core-scroll-header-panel.html">
<link rel="import" href="../dependencies/core-toolbar/core-toolbar.html">
<link rel="import" href="../dependencies/core-icon-button/core-icon-button.html">
<link rel="import" href="../dependencies/core-list/core-list.html">
<polymer-element name="search-screen" extends="force-route" attributes="sobject searchfields fieldstofetch resultHeight">
    <template>

        <link rel="stylesheet" href="search-screen.css"/>

        <core-scroll-header-panel id="scrollHeader" touch-action="pan-y">
            
            <core-toolbar id="header" class="header-toolbar">
                <core-icon id="menu-icon" class="icon" icon="menu"></core-icon>
                <div class="title" flex>{{$.list.collection.models.length || ""}} Contacts</div>
            </core-toolbar>

            <core-toolbar id="toolbar" class="search-toolbar">

                <core-icon id="sync_icon" class="icon" icon="notification:sync" on-tap="{{fireSyncUp}}"></core-icon>
                <div class="search-box" flex layout horizontal center>
                    <core-icon id="search_icon" icon="search" class="search-icon"></core-icon>
                    <force-ui-search id="search" sobject="{{sobject}}" searchfields="{{searchfields}}" fieldstofetch="{{fieldstofetch}}" cachemode="{{cachemode}}" flex on-down="{{searchFocused}}" on-touchend="{{stopClick}}"></force-ui-search>
                </div>
                <core-icon id="create_icon" class="icon" icon="add" on-tap="{{navigateToCreate}}"></core-icon>
                <div class="cancelBtn" on-tap="{{cancelSearch}}">Cancel</div>
              
            </core-toolbar>

            <div class="content">
                <img id="loading" class="loadingInd" src="loading-gray.gif"/>
                <force-sobject-sync sobject="{{sobject}}" fieldstoindex="{{searchfields}}" query="{{syncQuery}}" on-synccomplete="{{fetchData}}"></force-sobject-sync>
                <force-sobject-collection id="list" sobject="{{sobject}}" querytype="{{$.search.querytype}}" query="{{$.search.query}}" autosync="false"></force-sobject-collection>
                <core-list id="uilist" height="{{resultHeight}}" data="{{$.list.collection.models}}" on-touchend="{{stopClick}}">
                    <content select="*"></content>
                </core-list>

            </div>

        </core-scroll-header-panel>

    </template>
    <script>
        (function() {

            Polymer('search-screen', {
              cachemode: Force.CACHE_MODE.CACHE_ONLY,
              ready: function() {
                this.super();
                this.async(this.initialize);
              },

              initialize: function() {
                this.fetchData();
                var scrollHeader = this.$.scrollHeader;
                var input = this.$.search.$.input.$.input;
                scrollHeader.addEventListener('transitionend', function() {
                  scrollHeader.classList.remove('animating');
                  if (scrollHeader.classList.contains('search')) {
                        scrollHeader.style.transform = 
                            scrollHeader.style.webkitTransform = 'translate3d(0, 0, 0)';
                        scrollHeader.style.top = '-64px';
                        input.style.visibility = '';
                        input.focus(); // required by chrome
                  } else scrollHeader.style.top = '0px';
                });
                this._viewportHeight = window.innerHeight * 2; // Adding safety margin
                this.$.uilist.addEventListener('scroll', this.scrollHandler.bind(this), false);
              },

              scrollHandler: function(e, detail) {
                var scrollTop = e.detail ? e.detail.target.scrollTop : e.target.scrollTop;
                var totalHeight = this.resultHeight * this.$.list.collection.size();
                if (scrollTop > (totalHeight - this._viewportHeight)) 
                  this.async(function() { this.$.list.fetchMore(); });
              },

              searchFocused: function() {
                if (!this._searchFocued) {
                  this._searchFocued = true;
                  this.$.search.$.input.$.input.focus();
                  this.$.search.$.input.$.input.style.visibility = 'hidden';
                  this.$.scrollHeader.classList.add('search', 'animating');
                }
              },
              cancelSearch: function() {
                var scrollHeader = this.$.scrollHeader;
                this.$.search.criteria = '';
                scrollHeader.style.transform = 
                  scrollHeader.style.webkitTransform = '';
                scrollHeader.style.top = '0px';
                this.$.search.$.input.$.input.blur();
                this.async(function() { 
                     scrollHeader.classList.add('animating');
                     scrollHeader.classList.remove('search');
                     this._searchFocued = false;
                });
              },

              fireSyncUp: function() {
                this.$.sync_icon.classList.add('sync-animation');
                this.fire('syncup');
              },

              syncComplete: function() {
                this.$.sync_icon.classList.remove('sync-animation');
              },

              fetchData: function() {
                var onFetch = function() {
                  if (this.$.list.collection.size() > 0) {
                    this.$.loading.style.display = "none";
                    this.$.list.autosync = true;
                  } else this.setupSyncQuery();
                  this.$.list.removeEventListener('sync', onFetch);
                }.bind(this);

                if (!this.$.list.autosync) {
                  this.$.list.addEventListener('sync', onFetch);
                  this.async(function() { this.$.list.fetch(); });
                }
              },

              setupSyncQuery: function() {
                var searchFields = this.searchfields.trim().split(/\s+/);
                var fieldsToFetch = this.fieldstofetch ? this.fieldstofetch.trim().split(/\s+/) : [];
                fieldsToFetch = _.union(searchFields, fieldsToFetch);

                this.syncQuery = "SELECT Id, " + fieldsToFetch.join(',') + " FROM " + this.sobject + " LIMIT 4000";
              },

              stopClick: function(e) {
                e.preventDefault();
              },

              attached: function() {
                this.$.uilist.appendChild(this.querySelector('template'));
              },

              refresh: function() {
                this.$.list.fetch();
              },

              navigateToCreate: function() {
                window.location.hash = "#edit";
              }
            });
        })();
    </script>
</polymer-element>
