<polymer-element name="detail-screen" extends="force-route" attributes="sobject recordid sync" on-route-changed="{{render}}">
    <template>
        <link rel="stylesheet" href="detail.css"/>
        <core-toolbar id="toolbar" style="background-color: #f40009;">
          <core-icon id="back-icon" icon="chevron-left" on-tap="{{navigateBack}}" style="width: 45px; height: 45px; margin: -5px;" on-touchend="{{stopClick}}"></core-icon>
          <div flex></div>
          <div on-tap="{{doSave}}" style="color:white; line-height: 50px;">
            <template if="{{!sync && !$.detail.model.attributes.__locally_deleted__}}">Save</template>
            <template if="{{sync}}">Overwrite</template>
            <template if="{{$.detail.model.attributes.__locally_deleted__}}">Undelete</template>
          </div>
        </core-toolbar>
        <div style="position: absolute; top: 64px; bottom: 0; right: 0; left: 0; overflow-y: scroll; -webkit-overflow-scrolling: touch;" touch-action="pan-y">
            <force-paper-detail id="detail" sobject="{{sobject}}" recordid="{{recordid}}" foredit="true" fieldlist="FirstName LastName Title Department Phone Email HomePhone">
            </force-paper-detail>
            <template if="{{recordid && !$.detail.model.attributes.__locally_deleted__}}">
                <div on-tap="{{ doToggleDelete }}" horizontal layout center center-justified style="background-color: white; margin: 20px; color: rgb(255, 68, 68); height: 40px; font-size: 20px;border: 1px rgb(204, 204, 204) solid;border-radius: 5px;">Delete</div>
            </template>
        </div>
    </template>
    <script>
      Polymer('detail-screen', {
        sync: false,
        ready: function() {
            this.super();
            this.$.detail.fetchCacheMode = Force.CACHE_MODE.CACHE_ONLY;
        },
        get model() {
            return (this.$ ? this.$.detail.$.force_sobject : null);
        },
        render: function() {
            // Force detail re-render if recordid didn't change
            if (this.$.detail.model && this.$.detail.model.id == this.recordid) this.$.detail.render();
        },
        stopClick: function(e) {
            e.preventDefault();
        },
        navigateBack: function(ev) {
            window.history.back();
        },
        getSaveOptions: function(mergeMode, cacheMode) {
            var that = this;
            return {
                cacheMode: cacheMode,
                mergeMode: mergeMode,
                success: this.navigateBack,
                error: function(data, err, options) {
                    var error = new Force.Error(err);
                    if (error.type == "ConflictError") {
                        $(that.$.mergeButton).show();
                        $(that.$.overwriteButton).show();
                    }
                }
            };
        },

        handleError: function(error) {
            if (error.type == "ConflictError") {
                $(this.$.mergeButton).show();
                $(this.$.overwriteButton).show();
            }
        },

        doSave: function() {
            var cacheMode = this.sync ? Force.CACHE_MODE.SERVER_FIRST : Force.CACHE_MODE.CACHE_ONLY;
            // If model is locally deleted, then undelete. Else save
            if (this.$.detail.model.attributes.__locally_deleted__) this.doToggleDelete();
            else this.$.detail.save(this.getSaveOptions(Force.MERGE_MODE.MERGE_FAIL_IF_CHANGED, cacheMode));
        },

        doToggleDelete: function() {
            var that = this;
            var force_sobject = this.$.detail.$.force_sobject;
            if (force_sobject.fields.__locally_deleted__) {
                force_sobject.fields.__locally_deleted__ = false;
                var saveOptions = this.getSaveOptions(null, Force.CACHE_MODE.CACHE_ONLY);
                force_sobject.save(saveOptions);
            }
            else {
                force_sobject.destroy({
                    success: this.navigateBack,
                    error: function(data, err, options) {
                        var error = new Force.Error(err);
                        alert("Failed to delete " + that.sobject + ": " + (error.type === "RestError" ? error.details[0].message : "Remote change detected - delete aborted"));
                    }
                });
            }
        }
      })
    </script>
</polymer-element>
